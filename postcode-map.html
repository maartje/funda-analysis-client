<html>

<head>

    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>

    <script src="//d3js.org/d3.v3.min.js"></script>

    <script src="//maps.google.com/maps/api/js"></script>

    <style>
        #map {
            width: 500px;
            height: 500px;
        }
        
        .SvgOverlay {
            position: relative;
            width: 500px;
            height: 500px;
        }
        
        .SvgOverlay svg {
            position: absolute;
            top: -4000px;
            left: -4000px;
            width: 8000px;
            height: 8000px;
        }
        
        .SvgOverlay path {
            stroke: Black;
            stroke-width: 2px;
            /*fill: Orange;*/
            fill-opacity: .3;
        }
    </style>
</head>

<body>

    <div id="map-wrap">
        <div id="map">
        </div>
    </div>

    <script>
        /*global $*/
        /*global google*/
        /*global d3*/

        $(function() {

            var $map = $("#map");
            var ams_dam_square = [4.8932, 52.373];
            var map = new google.maps.Map($map[0], {
                zoom: 12,
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                center: new google.maps.LatLng(ams_dam_square[1], ams_dam_square[0]), // Mozambique
                styles: [{
                    "stylers": [{
                        "saturation": -20
                    }, {
                        "lightness": 20
                    }]
                }, {
                    featureType: 'poi.business',
                    stylers: [{
                        visibility: 'off'
                    }]
                }, {
                    featureType: 'transit',
                    elementType: 'labels.icon',
                    stylers: [{
                        visibility: 'off'
                    }]
                }]
            });
            d3.json("data/amsterdam-pc4.json", function(geoJson) {
                var overlay = new google.maps.OverlayView();
                overlay.onAdd = function() {
                    var layer = d3.select(this.getPanes().overlayLayer).append("div").attr("class", "SvgOverlay");
                    var svg = layer.append("svg");
                    var adminDivisions = svg.append("g").attr("class", "AdminDivisions");

                    overlay.draw = function() {
                        var markerOverlay = this;
                        var overlayProjection = markerOverlay.getProjection();

                        // Turn the overlay projection into a d3 projection
                        var googleMapProjection = function(coordinates) {
                            var googleCoordinates = new google.maps.LatLng(coordinates[1], coordinates[0]);
                            var pixelCoordinates = overlayProjection.fromLatLngToDivPixel(googleCoordinates);
                            return [pixelCoordinates.x + 4000, pixelCoordinates.y + 4000];
                        };

                        var path = d3.geo.path().projection(googleMapProjection);

                        d3.json("data/means_per_wijk.json", function(jsonData) {
                            var data = jsonData.means;
                            for (var i = 0; i < data.length; i++) {

                                var dataKey = data[i].postcode_wijk;
                                var dataValue = parseFloat(data[i].ppm2);

                                for (var j = 0; j < geoJson.features.length; j++) {

                                    var geoKey = geoJson.features[j].properties.PC4;

                                    if (dataKey == geoKey.toString()) {
                                        geoJson.features[j].properties.dataValue = dataValue;
                                        break;
                                    }
                                }
                            }





                            var color = d3.scale.quantize()
                                .range(["rgb(255,255,178)", "rgb(254,204,92)", "rgb(253,141,60)", "rgb(240,59,32)", "rgb(189,0,38)"])
                                // .range(["rgb(237,248,233)", "rgb(186,228,179)", "rgb(116,196,118)", "rgb(49,163,84)", "rgb(0,109,44)"])
                                .domain([d3.min(data, function(d) { return parseFloat(d.ppm2); }), d3.max(data, function(d) { return parseFloat(d.ppm2); })]);

                            adminDivisions.selectAll("path")
                                .data(geoJson.features)
                                .attr("d", path) // update existing paths
                                .enter().append("svg:path")
                                .attr("d", path)
                                .style("fill", function(d, i) {
                                    var value = d.properties.dataValue;
                                    console.log(i, d.properties.PC4, value)

                                    if (value) {
                                        return color(value);
                                    }
                                    else {
                                        return "#ccc";
                                    }

                                });


                        });

                    };

                };

                overlay.setMap(map);


            });
        });
    </script>

</body>

</html>
